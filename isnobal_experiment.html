<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ISNOBAL Adaptor Demo via an Experiment &mdash; VW Python API</title>
    
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="VW Python API" href="index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="index.html">VW Python API</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="isnobal-adaptor-demo-via-an-experiment">
<h1>ISNOBAL Adaptor Demo via an Experiment<a class="headerlink" href="#isnobal-adaptor-demo-via-an-experiment" title="Permalink to this headline">¶</a></h1>
<p>The ISNOBAL model is widely used, but with little coherence between research
groups. At least, this is what&#8217;s reflected in the lack of web-available
tutorial-style documentation and lack of <a class="reference external" href="https://github.com/search?utf8=%E2%9C%93&amp;q=isnobal&amp;type=Repositories&amp;ref=searchresults">open source code for isnobal</a>
or for relevant <a class="reference external" href="https://github.com/search?utf8=%E2%9C%93&amp;q=ipw&amp;type=Repositories&amp;ref=searchresults">IPW functions</a>.</p>
<p>In this tutorial we follow the example experiment that&#8217;s written in
<code class="docutils literal"><span class="pre">examples/temperature_experiment.bash</span></code>. Here we use all the tools of the
<code class="docutils literal"><span class="pre">isnobal_adaptor</span></code> module of our <code class="docutils literal"><span class="pre">adaptors</span></code> project.</p>
<p>To get started, run the bash script listed above. If all is well, you can open
the figure that gets saved as <code class="docutils literal"><span class="pre">example_plot.png</span></code>. For now it is pretty boring,
since the demo is initially configured to only run with eleven input files.</p>
<p>To make a more interesting figure, you can make some modifications to the
bash experiment script, but it will take much longer to run. In fact, you
probably want to run it over night. On my MacBook Pro with 16GB of ram, an
SSD hard drive, and an i7 processor it takes several hours to run
the entire experiment. This can certainly be improved, but for our purposes at
this time, this is good enough.</p>
<div class="section" id="the-experiment-how-does-atmospheric-temperature-effect-snow-melt">
<h2>The Experiment: (How) does atmospheric temperature effect snow melt?<a class="headerlink" href="#the-experiment-how-does-atmospheric-temperature-effect-snow-melt" title="Permalink to this headline">¶</a></h2>
<p>The iSNOBAL model takes a suite of inputs at each time step with 6 required
input variables and possibly some precipitation variables if there was any
precipitation in a given hour. One of the six required inputs is atmospheric
temperature. Our experiment aims to answer the question, &#8220;What is the effect of
increasing atmospheric temperature on snow melt?&#8221; Although to be complete
scientifically we&#8217;d want to also consider secondary effects of increased
temperature, like a higher percentage of rain to snow and changes in
total precipitation, we only modify temperature and consider its effects.</p>
<p>Using observational data from the Kormos FTP site, we
run the iSNOBAL model on the observed data, increase the atmospheric temperature
by a given amount at every time step, run the iSNOBAL model for the observed
input data and every modified set of input data, sum the total melting at
each time step, saves the total melt by hour for each temperature scenario to
a csv file, and plots the results. We do this by running the script, explained
below.</p>
</div>
<div class="section" id="sub-scripts-used-in-the-experiment">
<h2>Sub-scripts Used in the Experiment<a class="headerlink" href="#sub-scripts-used-in-the-experiment" title="Permalink to this headline">¶</a></h2>
<p>In running the experiment, we use five separate Python scripts, shown in
their entirety below. They can be run independently in an IPython shell
(with <code class="docutils literal"><span class="pre">run</span> <span class="pre">script.py</span></code>) as well as from the command line.</p>
<p>A lot of the script is fancy stuff for downloading the files reliably and making
sure our test case and full experiment both work.</p>
<p>Both the testing version and the full experiment download data from the
<a class="reference external" href="ftp://icewater.boisestate.edu/boisefront-products/other/projects/Kormos_iSNOBAL/">&#8220;icewater&#8221; FTP site for the Kormos ISNOBAL paper</a></p>
<p>The test version downloads about 11 files and runs the experiment. For the test
run, the resulting plot is pretty boring: there is only 11 hours
worth of data and no snow to melt, so the graph is a flat line at zero kg/m^2.</p>
<p>To run the full experiment, search for comments that contain the string
<code class="docutils literal"><span class="pre">CHANGE</span> <span class="pre">FOR</span> <span class="pre">FULL</span></code>. There you&#8217;ll find instructions on how to comment and
uncomment the code that will result in either a test run or a full run.</p>
<div class="section" id="sub-script-1-load-a-set-of-inputs-change-t-a-at-every-grid-point-and-time-step">
<h3>Sub-script 1: Load a set of inputs; change <code class="docutils literal"><span class="pre">T_a</span></code> at every grid point and time step<a class="headerlink" href="#sub-script-1-load-a-set-of-inputs-change-t-a-at-every-grid-point-and-time-step" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#!/usr/local/bin/python</span>
<span class="c"># assume observations are in obs_inputs/ and destination is inputs/</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">adaptors.src.isnobal_adaptor</span> <span class="kn">import</span> <span class="n">IPW</span>

<span class="c"># for simplicity, cl arg 1 is the source file, 2 is dest dir, and 3 is</span>
<span class="c"># amount to change by</span>
<span class="n">source_file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">dest_dir</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">amount</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

<span class="n">ipw</span> <span class="o">=</span> <span class="n">IPW</span><span class="p">(</span><span class="n">source_file</span><span class="p">)</span>
<span class="n">ipw</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">T_a</span> <span class="o">=</span> <span class="n">ipw</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">T_a</span> <span class="o">+</span> <span class="n">amount</span>
<span class="c"># required for proper writing. if new amounts exceed header max, trouble ensues..</span>
<span class="n">ipw</span><span class="o">.</span><span class="n">recalculate_header</span><span class="p">()</span>

<span class="n">output_file</span> <span class="o">=</span> <span class="n">dest_dir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">source_file</span><span class="p">)</span>
<span class="n">ipw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="sub-script-2-generate-csv-of-total-melt-per-hour-from-eight-different-climate-scenario-simulations">
<h3>Sub-script 2: Generate CSV of total melt per hour from eight different &#8220;climate scenario&#8221; simulations<a class="headerlink" href="#sub-script-2-generate-csv-of-total-melt-per-hour-from-eight-different-climate-scenario-simulations" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">adaptors.src.isnobal_adaptor</span> <span class="kn">import</span> <span class="n">IPW</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="n">melt_sums</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;P0.5&quot;</span><span class="p">,</span> <span class="s">&quot;P1.0&quot;</span><span class="p">,</span> <span class="s">&quot;P1.5&quot;</span><span class="p">,</span> <span class="s">&quot;P2.0&quot;</span><span class="p">,</span> <span class="s">&quot;P2.5&quot;</span><span class="p">,</span> <span class="s">&quot;P3.0&quot;</span><span class="p">,</span>
               <span class="s">&quot;P3.5&quot;</span><span class="p">,</span> <span class="s">&quot;P4.0&quot;</span><span class="p">]:</span>

    <span class="n">dir_name</span> <span class="o">=</span> <span class="s">&quot;outputs&quot;</span> <span class="o">+</span> <span class="n">val</span>

    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_name</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)]</span>

    <span class="n">melt_sums</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">IPW</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">melt</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>

<span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s">&#39;10/01/2010&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">8758</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s">&#39;H&#39;</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">melt_sums</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s">&quot;temperature_sensitivity_example.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="sub-script-3-resample-output-from-the-water-melt-example-above">
<h3>Sub-script 3: Resample output from the water melt example above<a class="headerlink" href="#sub-script-3-resample-output-from-the-water-melt-example-above" title="Permalink to this headline">¶</a></h3>
<p>Read more about resampling with a pandas timeseries dataframe
<a class="reference external" href="http://pandas.pydata.org/pandas-docs/dev/timeseries.html#up-and-downsampling">here</a>,
as well as this <a class="reference external" href="http://stackoverflow.com/questions/17001389/pandas-resample-documentation">helpful stack overflow thread</a>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#!/usr/local/bin/python</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">rcParams</span>
<span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;figure.autolayout&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>

<span class="c"># nice looking plots are default with pandas</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">mpl_style</span> <span class="o">=</span> <span class="s">&quot;default&quot;</span>

<span class="c"># load data saved to csv from previous example</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">&quot;data/temperature_sensitivity_example.csv&quot;</span><span class="p">)</span>
<span class="c"># have to re-assign because pandas doesn&#39;t parse it automatically. probably a</span>
<span class="c"># way to tell it to read the index as a date_time.</span>
<span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s">&#39;10/01/2010&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s">&#39;H&#39;</span><span class="p">)</span>

<span class="c"># TODO for full run, resample to 3-day sums</span>
<span class="c"># df_3day = df.resample(&#39;3D&#39;, how=np.sum)</span>

<span class="c"># set styles and plot</span>
<span class="n">styles</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="s">&#39;--&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="s">&#39;--&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="s">&#39;--&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="s">&#39;--&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">]</span>

<span class="c"># TODO toggle commenting on next two lines when doing a full run</span>
<span class="c"># ax = df_3day.plot(lw=3.5, style=styles)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lw</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">styles</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Three-day sum of melt for observed/obs-plus temperatures&#39;</span><span class="p">,</span>
          <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Date&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Melt (kg/m^2)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c"># draw the legend in the upper-left corner</span>
<span class="n">leg</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;size&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">})</span>

<span class="c"># set the linewidth of each legend object</span>
<span class="k">for</span> <span class="n">legobj</span> <span class="ow">in</span> <span class="n">leg</span><span class="o">.</span><span class="n">legendHandles</span><span class="p">:</span>
        <span class="n">legobj</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&quot;example_plot.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;png&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="figure" id="id1">
<a class="reference internal image-reference" href="_images/no_temp_melt.png"><img alt="Resampled predictions for snowmelt over three day periods for various heating temps" src="_images/no_temp_melt.png" /></a>
<p class="caption"><span class="caption-text">We ran the ISNOBAL model for nine different temperatures, the observed
temperatures from Kormos, et al., and then the observed heated by
0.5, 1.0, ..., 4.0 degrees Celsius. This is the output from the full
experiment. Click to enlarge.</span></p>
</div>
</div>
<div class="section" id="other-sub-scripts">
<h3>Other Sub-scripts<a class="headerlink" href="#other-sub-scripts" title="Permalink to this headline">¶</a></h3>
<p>There are two other scripts, <code class="docutils literal"><span class="pre">run_isnobal.py</span></code> and <code class="docutils literal"><span class="pre">recalc_input_headers.py</span></code>.
<code class="docutils literal"><span class="pre">run_isnobal.py</span></code> is a straight-forward wrapper of the
<code class="docutils literal"><span class="pre">adaptors.src.isnobal_adaptor.isnobal</span></code> function, which in turn is a wrapper
of the command-line <code class="docutils literal"><span class="pre">isnobal</span></code> command.</p>
<p><code class="docutils literal"><span class="pre">recalc_input_headers.py</span></code> is
required to transform the original data&#8217;s quantization to our quantization.
Basically, in our implementation of calculating an IPW file&#8217;s header, we look
at the maximum and minimum values present in the data, and then transform that
to an integer with the original header-defined number of bytes.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/wc_wave_triangles.png" alt="Logo"/>
            </a></p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">ISNOBAL Adaptor Demo via an Experiment</a><ul>
<li><a class="reference internal" href="#the-experiment-how-does-atmospheric-temperature-effect-snow-melt">The Experiment: (How) does atmospheric temperature effect snow melt?</a></li>
<li><a class="reference internal" href="#sub-scripts-used-in-the-experiment">Sub-scripts Used in the Experiment</a><ul>
<li><a class="reference internal" href="#sub-script-1-load-a-set-of-inputs-change-t-a-at-every-grid-point-and-time-step">Sub-script 1: Load a set of inputs; change <code class="docutils literal"><span class="pre">T_a</span></code> at every grid point and time step</a></li>
<li><a class="reference internal" href="#sub-script-2-generate-csv-of-total-melt-per-hour-from-eight-different-climate-scenario-simulations">Sub-script 2: Generate CSV of total melt per hour from eight different &#8220;climate scenario&#8221; simulations</a></li>
<li><a class="reference internal" href="#sub-script-3-resample-output-from-the-water-melt-example-above">Sub-script 3: Resample output from the water melt example above</a></li>
<li><a class="reference internal" href="#other-sub-scripts">Other Sub-scripts</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/isnobal_experiment.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Tri-State EPSCoR: WC-WAVE.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.4</a>
      
      |
      <a href="_sources/isnobal_experiment.txt"
          rel="nofollow">Page source</a></li>
    </div>

    

    
  </body>
</html>